<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Chiếu YouTube Receiver</title>
    <style>
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: #000; overflow: hidden;
        }
        #player { width: 100vw; height: 100vh; }
		
      		/* Vùng chứa cho dòng chữ chạy */
        #overlay-container {
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            overflow: hidden;      /* Ẩn phần vượt khung */
            pointer-events: none;  /* Cho phép click xuyên qua */
            z-index: 2;            /* Hiển thị trên video */
        }
        /* Dòng chữ chạy */
        #viewer-overlay {
            color: #CC0000;
            font-weight: bold;
            font-family: sans-serif;
            font-size: 40px;
            text-shadow: 1px 1px 2px #000;
            display: block;
            white-space: nowrap;
            will-change: transform; /* Tối ưu hiệu suất */
            opacity: 0;             /* Ẩn khi chưa có nội dung */
            position: relative;
            left: 0;
        }
        #reward-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.85); color: #FF0000;
            font-weight: bold; font-size: 48px; padding: 30px 60px;
            border-radius: 15px; opacity: 0; transition: opacity 0.5s ease-in-out;
            text-align: center; z-index: 1000;
        }
    </style>
	<script>
    // ----- Marquee động: chạy qua lại giữa 2 mép màn hình cho mọi độ dài chữ -----
    (function () {
        let styleEl;
        function injectKeyframes(distance) {
            if (!styleEl) {
                styleEl = document.createElement('style');
                styleEl.id = 'marquee-style';
                document.head.appendChild(styleEl);
            }
            styleEl.textContent = `
                @keyframes marqueeAnim {
                    0% { transform: translateX(0); }
                    100% { transform: translateX(${distance}px); }
                }
            `;
            console.log('[Marquee] Keyframes injected:', styleEl.textContent);
        }

        // Public để có thể gọi lại sau khi cập nhật nội dung
        window.setMarquee = function () {
            const textEl = document.getElementById('viewer-overlay');
            if (!textEl) {
                console.log('[Marquee] Text element not found');
                return;
            }

            // đo kích thước thực
            const screenWidth = window.innerWidth;
            const textWidth = textEl.scrollWidth;
            
            console.log('[Marquee] Screen width:', screenWidth, 'Text width:', textWidth);

            // Khoảng di chuyển: luôn chạy từ trái sang phải
            const distance = -(screenWidth + textWidth);
            
            // Tốc độ tỉ lệ theo quãng đường, có chặn min/max để dễ nhìn
            const duration = Math.max(8000, Math.min(30000, Math.abs(distance) * 8));
            
            console.log('[Marquee] Distance:', distance, 'Duration:', duration);

            injectKeyframes(distance);
            textEl.style.animation = `marqueeAnim ${duration}ms linear infinite alternate`;
            
            console.log('[Marquee] Animation applied:', textEl.style.animation);
        };

        // Debounce resize để cập nhật lại quỹ đạo khi đổi kích thước màn hình
        window.addEventListener('resize', () => {
            clearTimeout(window.__marqueeResizeTimer);
            window.__marqueeResizeTimer = setTimeout(window.setMarquee, 150);
        });
    })();
    </script>
</head>
<body>

<div id="player"></div>
<div id="overlay-container">
        <div id="viewer-overlay"></div>
    </div>
<div id="reward-overlay"></div>

<script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>
<script>
    const CUSTOM_NAMESPACE = "urn:x-cast:com.tranduyen.chieuyoutube.control";
    const context = cast.framework.CastReceiverContext.getInstance();
    const playerManager = context.getPlayerManager();
    const queueManager = playerManager.getQueueManager();
    const viewerOverlay = document.getElementById('viewer-overlay');
    const rewardOverlay = document.getElementById('reward-overlay');
    let ytPlayer;
    let isYouTubeReady = false;
    let currentVideoId = null;

    function log(message) {
        console.log('[YouTube Receiver]', message);
    }

    // YouTube Player - giống hệt test_cast_receiver.html
    window.onYouTubeIframeAPIReady = function() {
        log('YouTube IFrame API ready');
        ytPlayer = new YT.Player('player', {
            height: '100%', width: '100%',
            playerVars: { 'autoplay': 1, 'controls': 1, 'rel': 0 },
            events: { 
                'onStateChange': onPlayerStateChange,
                'onReady': onPlayerReady,
                'onError': onPlayerError
            }
        });
    };

    function onPlayerReady(event) {
        log('YouTube Player ready');
        isYouTubeReady = true;
    }

    function onPlayerError(event) {
        log(`YouTube Player error: ${event.data}`);
    }

    function onPlayerStateChange(event) {
        log(`Player state: ${event.data}`);
        if (event.data === YT.PlayerState.ENDED) {
            log('Video ended');
            viewerOverlay.style.opacity = 0;
            
            // Show reward message if available
            const currentItem = queueManager.getCurrentItem();
            if (currentItem?.media?.customData?.viewerName) {
                showRewardMessage(currentItem);
            }
            
            // Auto advance to next video after delay
            setTimeout(() => {
                const nextItem = queueManager.getNextItem();
                const currentIndex = queueManager.getCurrentItemIndex();
                const queueLength = queueManager.getQueue().length;
                log(`Auto advance check - currentIndex: ${currentIndex}, queueLength: ${queueLength}, nextItem: ${nextItem ? 'exists' : 'null'}`);
                
                if (nextItem) {
                    log('Auto advancing to next item');
                    queueManager.jumpToItem(currentIndex + 1);
                    
                    // Gửi thông báo về app để cập nhật currentlyPlayingVideoId
                    const nextVideoId = nextItem.media.contentId;
                    try {
                        context.sendCustomMessage(CUSTOM_NAMESPACE, JSON.stringify({
                            type: "statusUpdate",
                            currentlyPlayingVideoId: nextVideoId
                        }));
                        log('Status update message sent to app for auto advance');
                    } catch (e) {
                        log('Failed to send status update message: ' + e.message);
                    }
                } else {
                    log('No next item available - end of queue reached');
                }
            }, 2000);
        } else if (event.data === YT.PlayerState.PLAYING) {
            log('Video started playing');
        }
    }

    // Cast Message Interceptors - giống hệt test_cast_receiver.html
    playerManager.setMessageInterceptor(
        cast.framework.messages.MessageType.LOAD,
        loadRequestData => {
            const media = loadRequestData.media;
            const videoId = media.contentId;
            const customData = media.customData || {};
            
            log(`LOAD command received: ${videoId}`);
            currentVideoId = videoId;
            
            if (isYouTubeReady && ytPlayer && videoId) {
                log(`Loading video: ${videoId}`);
                ytPlayer.loadVideoById({ videoId, suggestedQuality: 'hd1080' });
            } else {
                log('YouTube player not ready for LOAD');
            }
            
            // Show viewer name if available
            if (customData.viewerName) {
                viewerOverlay.textContent = `Ca sỹ trình bày: ${customData.viewerName}`;
                viewerOverlay.style.opacity = 1;
                console.log('[Marquee] Setting marquee for viewer:', customData.viewerName);
                window.setMarquee(); // Cập nhật animation cho dòng chữ mới
            } else {
                viewerOverlay.textContent = "";
                viewerOverlay.style.opacity = 0;
                console.log('[Marquee] No viewer name, hiding overlay');
            }
            
            return null;
        }
    );

    playerManager.setMessageInterceptor(
        cast.framework.messages.MessageType.PLAY,
        () => { 
            log('PLAY command received');
            if (isYouTubeReady && ytPlayer) {
                ytPlayer.playVideo();
            }
            return null; 
        }
    );

    // Thêm message interceptor cho QUEUE_UPDATE để đồng bộ trạng thái
    playerManager.setMessageInterceptor(
        cast.framework.messages.MessageType.QUEUE_UPDATE,
        queueUpdateData => {
            log('QUEUE_UPDATE command received');
            const currentItem = queueManager.getCurrentItem();
            if (currentItem) {
                const videoId = currentItem.media.contentId;
                log(`Current video changed to: ${videoId}`);
                // Gửi thông báo về app để cập nhật currentlyPlayingVideoId
                try {
                    const message = JSON.stringify({
                        type: "statusUpdate",
                        currentlyPlayingVideoId: videoId
                    });
                    context.sendCustomMessage(CUSTOM_NAMESPACE, message);
                    log('Status update message sent to app: ' + message);
                } catch (e) {
                    log('Failed to send status update message: ' + e.message);
                }
            }
            return null;
        }
    );

    // Chỉ giữ lại chức năng chọn video trực tiếp từ danh sách
    context.addCustomMessageListener(CUSTOM_NAMESPACE, event => {
        const data = event.data;
        log(`Received custom message: ${JSON.stringify(data)}`);
        log(`Message type: ${typeof data}, cmd: ${data?.cmd}`);
        
        if (data && data.cmd === "playById") {
            log(`Play by ID command: ${data.videoId}`);
            const queue = queueManager.getQueue();
            log(`Queue length: ${queue.length}, searching for videoId: ${data.videoId}`);
            
            for (let i = 0; i < queue.length; i++) {
                const item = queue[i];
                const itemVideoId = item.media.contentId;
                log(`Checking item ${i}: ${itemVideoId}`);
                
                if (itemVideoId === data.videoId) {
                    log(`Found video at index ${i}, jumping to it`);
                    queueManager.jumpToItem(i);
                    
                    // Gửi thông báo về app để cập nhật currentlyPlayingVideoId
                    try {
                        context.sendCustomMessage(CUSTOM_NAMESPACE, JSON.stringify({
                            type: "statusUpdate",
                            currentlyPlayingVideoId: data.videoId
                        }));
                        log('Status update message sent to app for playById');
                    } catch (e) {
                        log('Failed to send status update message: ' + e.message);
                    }
                    break;
                }
            }
            
            if (queue.length === 0) {
                log('Queue is empty - cannot find video');
            }
        }
        // Đã loại bỏ chức năng playNext và setRepeatMode
    });

    function showRewardMessage(item) {
        if (item?.media?.customData?.viewerName) {
            const viewerName = item.media.customData.viewerName;
            const score = Math.floor(Math.random() * 11) + 90;
            rewardOverlay.innerHTML = `Ca sỹ ${viewerName} đã thể hiện bài hát rất tốt,<br>điểm khen ngợi ${score} điểm.`;
            rewardOverlay.style.opacity = 1;
            log(`Showing reward message for ${viewerName} with score ${score}`);
            setTimeout(() => { 
                rewardOverlay.style.opacity = 0; 
                log('Reward message hidden');
            }, 4000);
        }
    }

    // Start Cast receiver
    const options = new cast.framework.CastReceiverOptions();
    options.disableIdleTimeout = true;
    context.start(options);
    
    log('Cast receiver started');

    window.addEventListener('load', () => {
        log('Page loaded');
        
        // Test marquee functionality
        setTimeout(() => {
            console.log('[Marquee] Testing marquee functionality');
            const testText = "Test marquee - Ca sỹ trình bày: Test User";
            viewerOverlay.textContent = testText;
            viewerOverlay.style.opacity = 1;
            window.setMarquee();
            
            // Hide test after 5 seconds
            setTimeout(() => {
                viewerOverlay.style.opacity = 0;
                console.log('[Marquee] Test completed');
            }, 5000);
        }, 2000);
    });
</script>
</body>
</html>
