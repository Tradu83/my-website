<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Custom YouTube Cast Receiver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      background: #000; overflow: hidden;
    }
    #stage {
      position: relative;
      width: 100vw; height: 100vh;
      background: #000;
    }
    #player {
      position: absolute;
      left: 0; top: 0;
      width: 100%; height: 100%;
      border: 0; background: #000;
      z-index: 1;
    }
    #overlay-container {
      position: absolute;
      top: 20px; left: 0;
      width: 100%; overflow: hidden;
      pointer-events: none; z-index: 2;
    }
    #viewer-overlay {
      color: #CC0000;
      font-weight: bold; font-family: sans-serif;
      font-size: 40px; text-shadow: 1px 1px 2px #000;
      display: inline-block; white-space: nowrap;
      will-change: transform; opacity: 0;
    }
    #reward-overlay {
      position: absolute;
      bottom: 20%; left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: #fff; padding: 20px 30px;
      border-radius: 12px;
      font-size: 24px; text-align: center;
      z-index: 3; display: none;
    }
  </style>

  <!-- CAF Receiver -->
  <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
  <!-- YouTube IFrame API -->
  <script>
    (function loadYT() {
      const tag = document.createElement("script");
      tag.src = "https://www.youtube.com/iframe_api";
      document.head.appendChild(tag);
    })();
  </script>
  <script>
    // ===== Chữ chạy qua lại =====
    (function () {
      let styleEl;
      function injectKeyframes(distance) {
        if (!styleEl) {
          styleEl = document.createElement('style');
          styleEl.id = 'marquee-style';
          document.head.appendChild(styleEl);
        }
        styleEl.textContent = `
          @keyframes marqueeAnim {
            0% { transform: translateX(0); }
            100% { transform: translateX(${distance}px); }
          }
        `;
      }
      window.setMarquee = function () {
        const textEl = document.getElementById('viewer-overlay');
        if (!textEl) return;
        const screenWidth = window.innerWidth;
        const textWidth = textEl.scrollWidth;
        const distance = screenWidth - textWidth;
        const duration = Math.max(6000, Math.min(40000, Math.abs(distance) * 12));
        injectKeyframes(distance);
        textEl.style.animation = `marqueeAnim ${duration}ms linear infinite alternate`;
      };
      window.addEventListener('resize', () => {
        clearTimeout(window.__marqueeResizeTimer);
        window.__marqueeResizeTimer = setTimeout(window.setMarquee, 150);
      });
    })();
  </script>
</head>
<body>
  <div id="stage">
    <div id="player"></div>
    <div id="overlay-container">
      <div id="viewer-overlay"></div>
    </div>
    <div id="reward-overlay"></div>
  </div>

  <script>
    const context = cast.framework.CastReceiverContext.getInstance();
    const viewerOverlay = document.getElementById('viewer-overlay');
    const rewardOverlay = document.getElementById('reward-overlay');

    let ytPlayer = null;
    let ready = false;
    let rewardShown = false;
    let rewardCheckTimer = null;

    // Queue tự quản
    let myQueue = [];
    let currentIndex = 0;

    // Hàm hiển thị thông báo khen thưởng
    function showRewardMessage(item) {
      if (item && item.viewerName) {
        const viewerName = item.viewerName;
        const score = Math.floor(Math.random() * 11) + 90; // 90-100
        rewardOverlay.innerHTML = `Ca sỹ ${viewerName} đã thể hiện rất tốt!<br>${score} điểm khen ngợi.`;
        rewardOverlay.style.display = 'block';
        setTimeout(() => { rewardOverlay.style.display = 'none'; }, 4000);
      }
    }

    function loadVideoId(videoId, startTimeSec = 0) {
      if (!videoId) return;
      if (ready && ytPlayer) {
        ytPlayer.loadVideoById({
          videoId,
          startSeconds: Math.max(0, startTimeSec),
          suggestedQuality: 'hd1080'
        });
      } else {
        // Nếu player chưa ready, lưu tạm
        window.pendingVideoId = videoId;
        window.pendingStartTime = startTimeSec;
      }
    }

    // ===== YouTube Player Ready =====
    window.onYouTubeIframeAPIReady = function() {
      ytPlayer = new YT.Player('player', {
        height: '100%', width: '100%',
        playerVars: {
          autoplay: 1, controls: 0, rel: 0,
          modestbranding: 1, iv_load_policy: 3, disablekb: 1
        },
        events: {
          onReady: () => {
            ready = true;
            if (window.pendingVideoId) {
              loadVideoId(window.pendingVideoId, window.pendingStartTime || 0);
              window.pendingVideoId = null;
              window.pendingStartTime = 0;
            }
          },
          onStateChange: onYTStateChange
        }
      });
    };

    // ===== Xử lý trạng thái YouTube =====
    function onYTStateChange(event) {
      if (event.data === YT.PlayerState.PLAYING) {
        clearInterval(rewardCheckTimer);
        rewardCheckTimer = setInterval(() => {
          const duration = ytPlayer.getDuration();
          const current = ytPlayer.getCurrentTime();
          if (!rewardShown && duration - current <= 5) {
            showRewardMessage(myQueue[currentIndex]);
            rewardShown = true;
          }
        }, 1000);
      }
      if (event.data === YT.PlayerState.ENDED) {
        clearInterval(rewardCheckTimer);
        rewardShown = false;
        currentIndex++;
        if (currentIndex < myQueue.length) {
          updateOverlay(myQueue[currentIndex]);
          loadVideoId(myQueue[currentIndex].videoId);
        }
      }
      if (event.data === YT.PlayerState.PAUSED) {
        clearInterval(rewardCheckTimer);
      }
    }

    // ===== Overlay chữ chạy =====
    function updateOverlay(item) {
      if (item && item.viewerName) {
        viewerOverlay.textContent = `Ca sỹ trình bày: ${item.viewerName}`;
        viewerOverlay.style.opacity = 1;
        setTimeout(setMarquee, 0);
      } else {
        viewerOverlay.textContent = "";
        viewerOverlay.style.animation = "none";
        viewerOverlay.style.opacity = 0;
      }
    }

    // ===== Nhận lệnh từ app =====
    context.addCustomMessageListener('urn:x-cast:com.myapp.queue', (event) => {
      const data = event.data;
      if (data.action === "replaceQueue") {
        myQueue = data.queue || [];
        currentIndex = data.startIndex || 0;
        if (myQueue[currentIndex]) {
          updateOverlay(myQueue[currentIndex]);
          loadVideoId(myQueue[currentIndex].videoId);
        }
      }
      if (data.action === "appendQueue") {
        myQueue.push(...(data.queue || []));
      }
    });

    context.addCustomMessageListener('urn:x-cast:com.myapp.control', (event) => {
      const cmd = event.data;
      if (!ytPlayer) return;
      switch(cmd.action) {
        case "play": ytPlayer.playVideo(); break;
        case "pause": ytPlayer.pauseVideo(); break;
        case "seek": ytPlayer.seekTo(cmd.time || 0, true); break;
        case "next":
          if (currentIndex < myQueue.length - 1) {
            currentIndex++;
            updateOverlay(myQueue[currentIndex]);
            loadVideoId(myQueue[currentIndex].videoId);
          }
          break;
        case "prev":
          if (currentIndex > 0) {
            currentIndex--;
            updateOverlay(myQueue[currentIndex]);
            loadVideoId(myQueue[currentIndex].videoId);
          }
          break;
      }
    });

    const options = new cast.framework.CastReceiverOptions();
    options.disableIdleTimeout = true;
    context.start(options);
  </script>
</body>
</html>
