<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Chiếu YouTube Receiver</title>
    <style>
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: #000; overflow: hidden;
        }
        #player { width: 100vw; height: 100vh; }
        #overlay-container {
            position: absolute; top: 20px; left: 0;
            width: 100%; overflow: hidden;
            pointer-events: none; z-index: 2;
        }
        #viewer-overlay {
            color: #CC0000; font-weight: bold; font-family: sans-serif;
            font-size: 40px; text-shadow: 1px 1px 2px #000;
            display: inline-block; white-space: nowrap;
            will-change: transform; opacity: 0;
        }
        #reward-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.85);
            font-weight: bold;
            font-size: 36px;
            padding: 30px 60px; border-radius: 15px;
            opacity: 0; transition: opacity 0.5s ease-in-out; text-align: center;
            z-index: 1000;
            width: 80vw;
            box-sizing: border-box;
        }
        .reward-text-blue {
            color: #FFFFFF;
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .reward-score-red {
            font-size: 72px;
            font-weight: bold;
            color: #FF0000;
            line-height: 1.1;
            margin-top: 8px;
        }
       /* === BẮT ĐẦU KHỐI CSS MỚI CHO SPLASH SCREEN === */

#splash-screen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #000;
    z-index: 999;
    display: flex;
    justify-content: center;
    align-items: center;
    
    /* 1. Tạo không gian 3D cho các phần tử con */
    perspective: 800px; 
}

#splash-screen img {
    width: 250px;
    height: auto;
    
    /* 2. Áp dụng animation xoay cho chính logo */
    animation: rotate3D 5s linear infinite;
}

/* 3. Định nghĩa animation xoay 360 độ quanh trục Y (trục thẳng đứng) */
@keyframes rotate3D {
    from {
        transform: rotateY(0deg);
    }
    to {
        transform: rotateY(360deg);
    }
}

/* === KẾT THÚC KHỐI CSS MỚI === */
    </style>
    <script>
        (function () {
            let styleEl;
            function injectKeyframes(distance) {
                if (!styleEl) {
                    styleEl = document.createElement('style');
                    document.head.appendChild(styleEl);
                }
                styleEl.textContent = `@keyframes marqueeAnim { 0% { transform: translateX(0); } 100% { transform: translateX(${distance}px); } }`;
            }
            window.setMarquee = function () {
                const textEl = document.getElementById('viewer-overlay');
                if (!textEl) return;
                const screenWidth = window.innerWidth;
                const textWidth = textEl.scrollWidth;
                const distance = screenWidth - textWidth;
                const duration = Math.max(6000, Math.min(40000, Math.abs(distance) * 12));
                injectKeyframes(distance);
                textEl.style.animation = `marqueeAnim ${duration}ms linear infinite alternate`;
            };
            window.addEventListener('resize', () => {
                clearTimeout(window.__marqueeResizeTimer);
                window.__marqueeResizeTimer = setTimeout(window.setMarquee, 150);
            });
        })();
    </script>
</head>
<body>
    <div id="splash-screen">
    <img src="my_logo.png" alt="Ready to Cast">
	<p style="color: white; font-size: 30px; font-weight: bold; text-shadow: 1px 1px 3px black; margin-top: 20px;">
        CHƯƠNG TRÌNH HÁT KARAOKE BY TRẦN DUYÊN
    </p>
</div>
</div>
    <div id="player"></div>
    <div id="overlay-container"><div id="viewer-overlay"></div></div>
    <div id="reward-overlay"></div>

    <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
    // <<< BẮT ĐẦU NỘI DUNG SCRIPT ĐÃ SỬA >>>

    // <<< SỬA LỖI NGHIÊM TRỌNG: Namespace phải khớp với Service (dùng dấu chấm) >>>
    const CUSTOM_NAMESPACE = "urn:x-cast:com.tranduyen.chieuyoutube.custom";

    const context = cast.framework.CastReceiverContext.getInstance();
    const playerManager = context.getPlayerManager();
    const viewerOverlay = document.getElementById('viewer-overlay');
    const rewardOverlay = document.getElementById('reward-overlay');
    let ytPlayer;
    let isYouTubeReady = false;
    let currentViewerName = null;
	// <<< THAY ĐỔI 1: Tạo đối tượng Audio để chuẩn bị file nhạc >>>
	const rewardAudio = new Audio('music.mp3'); 

	let progressInterval = null;
	let isRewardShown = false;
    function log(message) {
        console.log('[YouTube Receiver]', message);
    }

    window.onYouTubeIframeAPIReady = function() {
        log('YouTube IFrame API ready');
        ytPlayer = new YT.Player('player', {
            height: '100%', width: '100%',
            playerVars: { 'autoplay': 1, 'controls': 1, 'rel': 0 },
            events: { 
                'onStateChange': onPlayerStateChange,
                'onReady': onPlayerReady,
                'onError': onPlayerError
            }
        });
    };

    function onPlayerReady(event) {
        log('YouTube Player ready');
        isYouTubeReady = true;
    }

    function onPlayerError(event) {
        // <<< SỬA LỖI: Lỗi chính tả nhỏ >>>
        log(`Youtubeer error: ${event.data}`);
    }

    function onPlayerStateChange(event) {
    log(`Player state: ${event.data}`);
    if (event.data === YT.PlayerState.ENDED) {
        // <<< BƯỚC 1: Lưu lại ID của video vừa thực sự kết thúc >>>
        const endedVideoId = currentVideoId; 

        log('Video ended. Displaying reward and setting a short delay.');
        viewerOverlay.style.opacity = 0;
        viewerOverlay.style.animation = "none";
        
        if (currentViewerName) {
            showRewardMessage(currentViewerName);
        }
        
        setTimeout(() => {
            // <<< BƯỚC 2: Chỉ gửi tín hiệu nếu không có video nào khác đã chen vào phát >>>
            // Nếu currentVideoId vẫn bằng endedVideoId, tức là không có gì thay đổi.
            if (currentVideoId === endedVideoId) {
                log(`Delay finished for ${endedVideoId}. Notifying sender to play next video.`);
                const message = { type: "VIDEO_ENDED" };
                context.sendCustomMessage(CUSTOM_NAMESPACE, undefined, message);
            } else {
                log(`Delay finished for ${endedVideoId}, but a new video (${currentVideoId}) is already playing. Cancelling autoplay.`);
            }
        }, 4500); // 4.5 giây
    }
}

    context.addCustomMessageListener(CUSTOM_NAMESPACE, event => {
        const data = event.data;
        log(`Received custom message: ${JSON.stringify(data)}`);
        
        if (data.type === "JUMP_TO" || data.type === "PLAY_NEXT") {
            if (data.media) {
                log(`Executing command '${data.type}' for video: ${data.media.contentId}`);
                loadVideoFromMessage(data.media);
            }
        }
    });

    function loadVideoFromMessage(media) {
	// <<< THAY ĐỔI 3: Dừng và reset nhạc khen thưởng khi video mới bắt đầu >>>
    rewardAudio.pause();
    rewardAudio.currentTime = 0;
        const splash = document.getElementById('splash-screen');
        if (splash) {
            splash.style.display = 'none';
        }

        const videoId = media.contentId;
        const customData = media.customData || {};

        if (isYouTubeReady && ytPlayer && videoId) {
            ytPlayer.loadVideoById({ videoId: videoId, suggestedQuality: 'hd1080' });
        }

        currentViewerName = customData.viewerName;
        if (currentViewerName) {
            viewerOverlay.textContent = `Ca sỹ trình bày: ${currentViewerName}`;
            viewerOverlay.style.opacity = 1;
            setTimeout(setMarquee, 0);
        } else {
            viewerOverlay.textContent = "";
            viewerOverlay.style.opacity = 0;
            viewerOverlay.style.animation = "none";
        }
    }

    playerManager.setMessageInterceptor(
        cast.framework.messages.MessageType.LOAD,
        loadRequestData => {
            log('Standard LOAD command received for the first video.');
            if (loadRequestData.media) {
                loadVideoFromMessage(loadRequestData.media);
            }
            return null;
        }
    );

    playerManager.setMessageInterceptor(
        cast.framework.messages.MessageType.PLAY,
        () => { if (ytPlayer) ytPlayer.playVideo(); return null; }
    );

    playerManager.setMessageInterceptor(
        cast.framework.messages.MessageType.PAUSE,
        () => { if (ytPlayer) ytPlayer.pauseVideo(); return null; }
    );

    function showRewardMessage(viewerName) {
        const startScore = 20;
        const finalScore = Math.floor(Math.random() * 11) + 90;
        let currentScore = startScore;

        rewardOverlay.innerHTML =
            `<div class="reward-text-blue">Ca sỹ ${viewerName} đã thể hiện bài hát rất tốt,</div>` +
            `<div class="reward-text-blue">điểm khen ngợi</div>` +
            `<div class="reward-score-red"><span id="score-counter">${startScore}</span> điểm</div>`;

        const scoreElement = document.getElementById('score-counter');
        rewardOverlay.style.opacity = 1;
        log(`Showing reward message for ${viewerName}. Counting from ${startScore} to ${finalScore}`);
		// <<< THAY ĐỔI 2: Phát nhạc khi thông báo hiển thị >>>
		rewardAudio.currentTime = 0; // Tua về đầu để đảm bảo nhạc phát từ đầu
		rewardAudio.play();
        const counterInterval = setInterval(() => {
            if (currentScore < finalScore) {
                currentScore++;
                scoreElement.textContent = currentScore;
            } else {
                clearInterval(counterInterval);
            }
        }, 50);

        // <<< SỬA LỖI: Đặt lại thời gian hiển thị là 10 giây >>>
        setTimeout(() => {
            rewardOverlay.style.opacity = 0;
            clearInterval(counterInterval);
            log('Reward message hidden');
        }, 7000); // 7 giây
    }

    const options = new cast.framework.CastReceiverOptions();
    options.disableIdleTimeout = true;
    context.start(options);
    log('Cast receiver started');

    </script>
</body>
</html>
