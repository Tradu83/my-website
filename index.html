<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Chiếu YouTube Receiver</title>
    <style>
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: #000; overflow: hidden;
        }
        #player { width: 100vw; height: 100vh; }
		
      		/* Vùng chứa cho dòng chữ chạy */
        #overlay-container {
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            overflow: hidden;      /* Ẩn phần vượt khung */
            pointer-events: none;  /* Cho phép click xuyên qua */
            z-index: 2;            /* Hiển thị trên video */
        }
        /* Dòng chữ chạy */
        #viewer-overlay {
            color: #CC0000;
            font-weight: bold;
            font-family: sans-serif;
            font-size: 40px;
            text-shadow: 1px 1px 2px #000;
            display: inline-block;
            white-space: nowrap;
            will-change: transform; /* Tối ưu hiệu suất */
            opacity: 0;             /* Ẩn khi chưa có nội dung */
        }
        #reward-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.85); color: #FF0000;
            font-weight: bold; font-size: 48px; padding: 30px 60px;
            border-radius: 15px; opacity: 0; transition: opacity 0.5s ease-in-out;
            text-align: center; z-index: 1000;
        }
    </style>
	<script>
    // ----- Marquee động: chạy qua lại giữa 2 mép màn hình cho mọi độ dài chữ -----
    (function () {
        let styleEl;
        function injectKeyframes(distance) {
            if (!styleEl) {
                styleEl = document.createElement('style');
                styleEl.id = 'marquee-style';
                document.head.appendChild(styleEl);
            }
            styleEl.textContent = `
                @keyframes marqueeAnim {
                    0% { transform: translateX(0); }
                    100% { transform: translateX(${distance}px); }
                }
            `;
        }

        // Public để có thể gọi lại sau khi cập nhật nội dung
        window.setMarquee = function () {
            const textEl = document.getElementById('viewer-overlay');
            if (!textEl) return;

            // đo kích thước thực
            const screenWidth = window.innerWidth;
            const textWidth = textEl.scrollWidth;

            // Khoảng di chuyển: dương nếu chữ ngắn hơn màn hình, âm nếu dài hơn
            const distance = screenWidth - textWidth;

            // Tốc độ tỉ lệ theo quãng đường, có chặn min/max để dễ nhìn
            const duration = Math.max(6000, Math.min(40000, Math.abs(distance) * 12));

            injectKeyframes(distance);
            textEl.style.animation = `marqueeAnim ${duration}ms linear infinite alternate`;
        };

        // Debounce resize để cập nhật lại quỹ đạo khi đổi kích thước màn hình
        window.addEventListener('resize', () => {
            clearTimeout(window.__marqueeResizeTimer);
            window.__marqueeResizeTimer = setTimeout(window.setMarquee, 150);
        });
    })();
    </script>
</head>
<body>

<div id="player"></div>
<div id="overlay-container">
        <div id="viewer-overlay"></div>
    </div>
<div id="reward-overlay"></div>

<script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>
<script>
    // <<< BẮT ĐẦU NỘI DUNG SCRIPT ĐÃ SỬA >>>

const CUSTOM_NAMESPACE = "urn:x-cast:com.tranduyen.chieuyoutube.custom";
const context = cast.framework.CastReceiverContext.getInstance();
const playerManager = context.getPlayerManager();
const viewerOverlay = document.getElementById('viewer-overlay');
const rewardOverlay = document.getElementById('reward-overlay');
let ytPlayer;
let isYouTubeReady = false;
let currentViewerName = null;

function log(message) {
    console.log('[YouTube Receiver]', message);
}

window.onYouTubeIframeAPIReady = function() {
    log('YouTube IFrame API ready');
    ytPlayer = new YT.Player('player', {
        height: '100%', width: '100%',
        playerVars: { 'autoplay': 1, 'controls': 1, 'rel': 0 },
        events: { 
            'onStateChange': onPlayerStateChange,
            'onReady': onPlayerReady,
            'onError': onPlayerError
        }
    });
};

function onPlayerReady(event) {
    log('YouTube Player ready');
    isYouTubeReady = true;
}

function onPlayerError(event) {
    log(`Youtubeer error: ${event.data}`);
}

function onPlayerStateChange(event) {
    log(`Player state: ${event.data}`);
    if (event.data === YT.PlayerState.ENDED) {
        log('Video ended. Displaying reward and setting a short delay.');
        viewerOverlay.style.opacity = 0;
        viewerOverlay.style.animation = "none";
        
        if (currentViewerName) {
            showRewardMessage(currentViewerName);
        }
        
        setTimeout(() => {
            log('Delay finished. Notifying sender to play next video.');
            const message = { type: "VIDEO_ENDED" };
            context.sendCustomMessage(CUSTOM_NAMESPACE, undefined, message);
        }, 9000); // 9 giây
    }
}

context.addCustomMessageListener(CUSTOM_NAMESPACE, event => {
    const data = event.data;
    log(`Received custom message: ${JSON.stringify(data)}`);
    
    if (data.type === "JUMP_TO" || data.type === "PLAY_NEXT") {
        if (data.media) {
            log(`Executing command '${data.type}' for video: ${data.media.contentId}`);
            // Bây giờ hàm này đã tồn tại và sẽ được gọi đúng
            loadVideoFromMessage(data.media);
        }
    }
});

// <<< KHÔI PHỤC LẠI HÀM loadVideoFromMessage BỊ THIẾU >>>
function loadVideoFromMessage(media) {
    const videoId = media.contentId;
    const customData = media.customData || {};

    if (isYouTubeReady && ytPlayer && videoId) {
        ytPlayer.loadVideoById({ videoId: videoId, suggestedQuality: 'hd1080' });
    }

    currentViewerName = customData.viewerName;
    if (currentViewerName) {
        viewerOverlay.textContent = `Ca sỹ trình bày: ${currentViewerName}`;
        viewerOverlay.style.opacity = 1;
        setTimeout(setMarquee, 0);
    } else {
        viewerOverlay.textContent = "";
        viewerOverlay.style.opacity = 0;
        viewerOverlay.style.animation = "none";
    }
}

playerManager.setMessageInterceptor(
    cast.framework.messages.MessageType.LOAD,
    loadRequestData => {
        log('Standard LOAD command received for the first video.');
        if (loadRequestData.media) {
            loadVideoFromMessage(loadRequestData.media);
        }
        return null;
    }
);

playerManager.setMessageInterceptor(
    cast.framework.messages.MessageType.PLAY,
    () => { if (ytPlayer) ytPlayer.playVideo(); return null; }
);

playerManager.setMessageInterceptor(
    cast.framework.messages.MessageType.PAUSE,
    () => { if (ytPlayer) ytPlayer.pauseVideo(); return null; }
);

function showRewardMessage(viewerName) {
    const startScore = 20;
    const finalScore = Math.floor(Math.random() * 11) + 90;
    let currentScore = startScore;

    rewardOverlay.innerHTML =
        `<div class="single-line-ellipsis">Ca sỹ ${viewerName} đã thể hiện bài hát rất tốt,</div>` +
        `<div class="single-line-ellipsis">điểm khen ngợi</div>` +
        `<div class="reward-score"><span id="score-counter">${startScore}</span> điểm</div>`;

    const scoreElement = document.getElementById('score-counter');
    rewardOverlay.style.opacity = 1;
    log(`Showing reward message for ${viewerName}. Counting from ${startScore} to ${finalScore}`);

    const counterInterval = setInterval(() => {
        if (currentScore < finalScore) {
            currentScore++;
            scoreElement.textContent = currentScore;
        } else {
            clearInterval(counterInterval);
        }
    }, 50);

    setTimeout(() => {
        rewardOverlay.style.opacity = 0;
        clearInterval(counterInterval);
        log('Reward message hidden');
    }, 10000); // 10 giây
}

const options = new cast.framework.CastReceiverOptions();
options.disableIdleTimeout = true;
context.start(options);
log('Cast receiver started');

// <<< KẾT THÚC NỘI DUNG SCRIPT ĐÃ SỬA >>>
</script>
</body>
</html>
