<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Chiếu YouTube Receiver</title>
    <style>
        /* CSS để đảm bảo video và overlay chiếm toàn bộ màn hình */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000; /* Nền đen khi không có video */
            overflow: hidden;
        }

        /* YouTube player container */
        #youtube-player {
            width: 100vw;
            height: 100vh;
            display: none; /* Ẩn cho đến khi cần thiết */
        }

        /* Lớp phủ để hiển thị tên người xem */
        #viewer-overlay {
            position: absolute;
            bottom: 10%;
            left: 20px;
            z-index: 1000;
            
            background-color: rgba(0, 0, 0, 0.6);
            color: #FFF;
            padding: 10px 20px;
            border-radius: 8px;
            font-family: sans-serif;
            font-size: 24px;

            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        /* Loading indicator */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            z-index: 1001;
        }

        /* Debug info */
        #debug-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            z-index: 1002;
            max-width: 300px;
        }
    </style>
</head>
<body>
    <div id="youtube-player"></div>
    <div id="viewer-overlay"></div>
    <div id="loading">Đang tải video...</div>
    <div id="debug-info">Debug: Khởi tạo...</div>

    <!-- YouTube IFrame API -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <!-- Cast Receiver Framework -->
    <script type="text/javascript" src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>

    <script>
        // Debug function
        function debugLog(message) {
            console.log(message);
            document.getElementById('debug-info').innerText = `Debug: ${message}`;
        }

        // Lấy các thực thể cốt lõi của Cast Framework
        const context = cast.framework.CastReceiverContext.getInstance();
        const playerManager = context.getPlayerManager();
        
        // Lấy tham chiếu đến các phần tử HTML
        const viewerOverlay = document.getElementById('viewer-overlay');
        const youtubePlayer = document.getElementById('youtube-player');
        const loading = document.getElementById('loading');
        const debugInfo = document.getElementById('debug-info');
        
        let player; // YouTube player instance
        let currentVideoId = null;
        let isYouTubePlayerReady = false;

        debugLog('Cast Framework khởi tạo');

        // Khởi tạo YouTube IFrame API
        function onYouTubeIframeAPIReady() {
            debugLog('YouTube IFrame API Ready');
            player = new YT.Player('youtube-player', {
                height: '100%',
                width: '100%',
                videoId: '',
                playerVars: {
                    'autoplay': 1,
                    'controls': 1,
                    'rel': 0,
                    'showinfo': 0,
                    'modestbranding': 1,
                    'fs': 1,
                    'playsinline': 0,
                    'enablejsapi': 1,
                    'origin': window.location.origin
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError
                }
            });
        }

        function onPlayerReady(event) {
            debugLog('YouTube Player Ready');
            isYouTubePlayerReady = true;
            loading.style.display = 'none';
        }

        function onPlayerStateChange(event) {
            debugLog(`Player State: ${event.data}`);
            
            switch (event.data) {
                case YT.PlayerState.PLAYING:
                    debugLog('Video đang phát');
                    loading.style.display = 'none';
                    break;
                    
                case YT.PlayerState.PAUSED:
                    debugLog('Video tạm dừng');
                    break;
                    
                case YT.PlayerState.ENDED:
                    debugLog('Video kết thúc');
                    viewerOverlay.style.opacity = 0;
                    break;
                    
                case YT.PlayerState.BUFFERING:
                    debugLog('Video đang buffer');
                    loading.style.display = 'block';
                    break;
                    
                case YT.PlayerState.CUED:
                    debugLog('Video sẵn sàng');
                    loading.style.display = 'none';
                    break;
            }
        }

        function onPlayerError(event) {
            debugLog(`YouTube Error: ${event.data}`);
            
            const errorMessages = {
                2: 'Tham số không hợp lệ',
                5: 'HTML5 player error',
                100: 'Video không tìm thấy',
                101: 'Video không được phép nhúng',
                150: 'Video không được phép nhúng'
            };
            
            const errorMessage = errorMessages[event.data] || 'Lỗi phát video';
            loading.innerText = errorMessage;
            viewerOverlay.style.opacity = 0;
        }

        // Hàm extract video ID từ URL
        function extractVideoId(url) {
            debugLog(`Extracting video ID from: ${url}`);
            
            const patterns = [
                /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/v\/)([^&\n?#]+)/,
                /youtube:\/\/([^&\n?#]+)/,
                /yt:\/\/([^&\n?#]+)/
            ];
            
            for (let pattern of patterns) {
                const match = url.match(pattern);
                if (match) {
                    const videoId = match[1];
                    debugLog(`Found video ID: ${videoId}`);
                    return videoId;
                }
            }
            
            debugLog('No video ID found');
            return null;
        }

        // Can thiệp vào tin nhắn LOAD để xử lý YouTube video
        playerManager.setMessageInterceptor(
            cast.framework.messages.MessageType.LOAD,
            loadRequestData => {
                debugLog('Load Request received');
                console.log('Load Request:', loadRequestData);
                
                const media = loadRequestData.media;
                const customData = media.customData;
                const contentId = media.contentId;
                
                debugLog(`Content ID: ${contentId}`);
                debugLog(`Custom Data: ${JSON.stringify(customData)}`);
                
                // Extract video ID từ URL
                const videoId = extractVideoId(contentId);
                
                if (videoId) {
                    debugLog(`Processing YouTube video: ${videoId}`);
                    currentVideoId = videoId;
                    
                    // Hiển thị YouTube player
                    youtubePlayer.style.display = 'block';
                    
                    // Load video vào YouTube player
                    if (isYouTubePlayerReady && player && player.loadVideoById) {
                        debugLog('Loading video into YouTube player');
                        player.loadVideoById(videoId);
                        loading.style.display = 'block';
                    } else {
                        debugLog('YouTube player not ready, waiting...');
                        // Đợi YouTube player sẵn sàng
                        const checkPlayerReady = setInterval(() => {
                            if (isYouTubePlayerReady && player && player.loadVideoById) {
                                debugLog('YouTube player ready, loading video now');
                                player.loadVideoById(videoId);
                                loading.style.display = 'block';
                                clearInterval(checkPlayerReady);
                            }
                        }, 100);
                    }
                    
                    // Hiển thị tên người xem
                    if (customData && customData.viewerName) {
                        debugLog(`Video added by: ${customData.viewerName}`);
                        viewerOverlay.innerText = `Người thêm: ${customData.viewerName}`;
                        viewerOverlay.style.opacity = 1;
                    } else {
                        viewerOverlay.style.opacity = 0;
                    }
                    
                    // Trả về null để ngăn Cast Framework xử lý media mặc định
                    return null;
                } else {
                    debugLog('Not a YouTube URL, using default player');
                    // Nếu không phải YouTube URL, sử dụng Cast Media Player mặc định
                    youtubePlayer.style.display = 'none';
                    
                    // Hiển thị tên người xem
                    if (customData && customData.viewerName) {
                        viewerOverlay.innerText = `Người thêm: ${customData.viewerName}`;
                        viewerOverlay.style.opacity = 1;
                    }
                    
                    return loadRequestData;
                }
            }
        );
        
        // Xử lý các lệnh điều khiển media
        playerManager.setMessageInterceptor(
            cast.framework.messages.MessageType.PLAY,
            () => {
                debugLog('Play command received');
                if (player && player.playVideo) {
                    player.playVideo();
                }
                return null;
            }
        );

        playerManager.setMessageInterceptor(
            cast.framework.messages.MessageType.PAUSE,
            () => {
                debugLog('Pause command received');
                if (player && player.pauseVideo) {
                    player.pauseVideo();
                }
                return null;
            }
        );

        playerManager.setMessageInterceptor(
            cast.framework.messages.MessageType.SEEK,
            (seekRequestData) => {
                debugLog(`Seek command received: ${seekRequestData.currentTime}`);
                if (player && player.seekTo) {
                    player.seekTo(seekRequestData.currentTime, true);
                }
                return null;
            }
        );

        playerManager.setMessageInterceptor(
            cast.framework.messages.MessageType.STOP,
            () => {
                debugLog('Stop command received');
                if (player && player.stopVideo) {
                    player.stopVideo();
                }
                return null;
            }
        );

        // Bắt đầu chạy Receiver
        const options = new cast.framework.CastReceiverOptions();
        options.disableIdleTimeout = true;
        context.start(options);

        debugLog('Custom YouTube Receiver Started!');
    </script>
</body>
</html>
