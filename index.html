<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Chiếu YouTube Receiver (Debug)</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #000; overflow: hidden; }
        #player { width: 100vw; height: 100vh; }
        #debug-overlay {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            background-color: rgba(0,0,0,0.7); color: #0f0; font-family: monospace;
            font-size: 16px; padding: 10px; border-radius: 5px; max-width: 95%;
        }
    </style>
</head>
<body>
    <div id="player"></div>
    <div id="debug-overlay"></div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>

    <script>
        const debugOverlay = document.getElementById('debug-overlay');
        function debugLog(message) {
            console.log(message);
            // Hiển thị tối đa 5 dòng log gần nhất trên màn hình
            let lines = debugOverlay.innerHTML.split('<br>').slice(-4);
            lines.push(message);
            debugOverlay.innerHTML = lines.join('<br>');
        }

        debugLog("1. Receiver script started.");

        const context = cast.framework.CastReceiverContext.getInstance();
        const playerManager = context.getPlayerManager();
        
        let ytPlayer;
        let isPlayerReady = false;
        let pendingMediaInfo = null; // Biến quan trọng để lưu yêu cầu đang chờ

        // Hàm này sẽ được gọi khi script của YouTube IFrame API tải xong
        window.onYouTubeIframeAPIReady = function() {
            debugLog("2. YouTube IFrame API is ready. Creating YT.Player...");
            ytPlayer = new YT.Player('player', {
                height: '100%', width: '100%',
                playerVars: { 'autoplay': 1, 'controls': 0 },
                events: {
                    'onReady': onPlayerReady
                }
            });
        };

        // Hàm này được gọi khi trình phát YouTube đã sẵn sàng nhận lệnh
        function onPlayerReady(event) {
            debugLog("3. YouTube Player is ready (onReady event fired).");
            isPlayerReady = true;
            // Kiểm tra xem có yêu cầu nào đang chờ không
            if (pendingMediaInfo) {
                debugLog("4. A pending media request was found. Playing it now...");
                playMedia(pendingMediaInfo);
                pendingMediaInfo = null; // Xóa yêu cầu đã xử lý
            }
        }
        
        // Hàm trung tâm để phát video
        function playMedia(mediaInfo) {
            const videoId = mediaInfo.contentId;
            debugLog(`5. Calling loadVideoById with ID: ${videoId}`);
            ytPlayer.loadVideoById({ videoId: videoId, suggestedQuality: 'hd1080' });
        }

        // Can thiệp vào lệnh LOAD từ điện thoại
        playerManager.setMessageInterceptor(
            cast.framework.messages.MessageType.LOAD,
            loadRequestData => {
                debugLog("A. LOAD message received from sender.");
                const media = loadRequestData.media;
                if (!media) {
                    debugLog("ERROR: Media object is missing in LOAD request.");
                    return null;
                }

                if (isPlayerReady) {
                    debugLog("B. Player is already ready. Playing immediately.");
                    playMedia(media);
                } else {
                    debugLog("C. Player is NOT ready yet. Storing media request to play later.");
                    pendingMediaInfo = media; // Lưu lại yêu cầu
                }
                
                return null; // Luôn trả về null để ngăn trình phát mặc định
            }
        );

        // Khởi động receiver
        context.start();

    </script>
</body>
</html>
