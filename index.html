<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Chiếu YouTube Receiver</title>
    <style>
        /* CSS để đảm bảo video và overlay chiếm toàn bộ màn hình */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000; /* Nền đen khi không có video */
            overflow: hidden;
        }

        /* Định dạng cho trình phát video của Google */
        cast-media-player {
            width: 100vw;
            height: 100vh;
            display: none; /* Ẩn cast-media-player mặc định */
        }

        /* YouTube player container */
        #youtube-player {
            width: 100vw;
            height: 100vh;
            display: none; /* Ẩn cho đến khi cần thiết */
        }

        /* Lớp phủ để hiển thị tên người xem */
        #viewer-overlay {
            position: absolute;
            bottom: 10%; /* Vị trí cách đáy màn hình 10% */
            left: 20px;  /* Vị trí cách lề trái 20px */
            z-index: 1000; /* Đảm bảo hiển thị trên video */
            
            background-color: rgba(0, 0, 0, 0.6); /* Nền đen mờ */
            color: #FFF; /* Chữ trắng */
            padding: 10px 20px;
            border-radius: 8px;
            font-family: sans-serif;
            font-size: 24px;

            /* Hiệu ứng mờ dần khi ẩn/hiện */
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        /* Loading indicator */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            z-index: 1001;
        }
    </style>
</head>
<body>

    <cast-media-player></cast-media-player>
    <div id="youtube-player"></div>
    <div id="viewer-overlay"></div>
    <div id="loading">Đang tải video...</div>

    <!-- YouTube IFrame API -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <!-- Cast Receiver Framework -->
    <script type="text/javascript" src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>

    <script>
        // Lấy các thực thể cốt lõi của Cast Framework
        const context = cast.framework.CastReceiverContext.getInstance();
        const playerManager = context.getPlayerManager();
        
        // Lấy tham chiếu đến các phần tử HTML
        const viewerOverlay = document.getElementById('viewer-overlay');
        const youtubePlayer = document.getElementById('youtube-player');
        const castMediaPlayer = document.querySelector('cast-media-player');
        const loading = document.getElementById('loading');
        
        let player; // YouTube player instance
        let currentVideoId = null;

        // Khởi tạo YouTube IFrame API
        function onYouTubeIframeAPIReady() {
            console.log('YouTube IFrame API Ready');
            player = new YT.Player('youtube-player', {
                height: '100%',
                width: '100%',
                videoId: '',
                playerVars: {
                    'autoplay': 1,
                    'controls': 1,
                    'rel': 0,
                    'showinfo': 0,
                    'modestbranding': 1,
                    'fs': 1,
                    'playsinline': 0
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError
                }
            });
        }

        function onPlayerReady(event) {
            console.log('YouTube Player Ready');
            loading.style.display = 'none';
        }

        function onPlayerStateChange(event) {
            console.log('Player State Changed:', event.data);
            
            // YT.PlayerState.PLAYING = 1
            // YT.PlayerState.PAUSED = 2
            // YT.PlayerState.ENDED = 0
            
            if (event.data === YT.PlayerState.ENDED) {
                // Video kết thúc, ẩn overlay
                viewerOverlay.style.opacity = 0;
                // Thông báo cho Cast Framework
                playerManager.onLoad();
            }
        }

        function onPlayerError(event) {
            console.error('YouTube Player Error:', event.data);
            loading.innerText = 'Lỗi phát video';
        }

        // Hàm extract video ID từ URL
        function extractVideoId(url) {
            const patterns = [
                /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/v\/)([^&\n?#]+)/,
                /youtube:\/\/([^&\n?#]+)/,
                /yt:\/\/([^&\n?#]+)/
            ];
            
            for (let pattern of patterns) {
                const match = url.match(pattern);
                if (match) {
                    return match[1];
                }
            }
            return null;
        }

        // Can thiệp vào tin nhắn LOAD để xử lý YouTube video
        playerManager.setMessageInterceptor(
            cast.framework.messages.MessageType.LOAD,
            loadRequestData => {
                console.log('Load Request:', loadRequestData);
                
                const media = loadRequestData.media;
                const customData = media.customData;
                const contentId = media.contentId;
                
                // Extract video ID từ URL
                const videoId = extractVideoId(contentId);
                
                if (videoId) {
                    console.log('YouTube Video ID:', videoId);
                    currentVideoId = videoId;
                    
                    // Hiển thị YouTube player
                    youtubePlayer.style.display = 'block';
                    castMediaPlayer.style.display = 'none';
                    
                    // Load video vào YouTube player
                    if (player && player.loadVideoById) {
                        player.loadVideoById(videoId);
                        loading.style.display = 'block';
                    }
                    
                    // Hiển thị tên người xem
                    if (customData && customData.viewerName) {
                        console.log('Video added by:', customData.viewerName);
                        viewerOverlay.innerText = `Người thêm: ${customData.viewerName}`;
                        viewerOverlay.style.opacity = 1;
                    } else {
                        viewerOverlay.style.opacity = 0;
                    }
                    
                    // Trả về null để ngăn Cast Framework xử lý media mặc định
                    return null;
                } else {
                    // Nếu không phải YouTube URL, sử dụng Cast Media Player mặc định
                    console.log('Using default Cast Media Player');
                    youtubePlayer.style.display = 'none';
                    castMediaPlayer.style.display = 'block';
                    
                    // Hiển thị tên người xem
                    if (customData && customData.viewerName) {
                        viewerOverlay.innerText = `Người thêm: ${customData.viewerName}`;
                        viewerOverlay.style.opacity = 1;
                    }
                    
                    return loadRequestData;
                }
            }
        );
        
        // Lắng nghe sự kiện thay đổi trạng thái của trình phát
        context.addEventListener(cast.framework.events.EventType.PLAYER_STATE_CHANGED, (event) => {
            console.log('Player State Changed:', event.playerState);
            
            // Nếu trình phát chuyển sang trạng thái IDLE
            if (event.playerState === cast.framework.messages.PlayerState.IDLE) {
                // Ẩn overlay
                viewerOverlay.style.opacity = 0;
                loading.style.display = 'none';
            }
        });

        // Xử lý các lệnh điều khiển từ ứng dụng Android
        playerManager.addEventListener(cast.framework.events.EventType.MEDIA_STATUS, (event) => {
            console.log('Media Status:', event);
        });

        // Bắt đầu chạy Receiver
        const options = new cast.framework.CastReceiverOptions();
        options.disableIdleTimeout = true; // Không để receiver tự ngắt kết nối
        context.start(options);

        console.log('Custom YouTube Receiver Started!');
    </script>
</body>
</html>
