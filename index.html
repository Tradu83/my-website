<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Chiếu YouTube Receiver</title>
    <style>
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: #000; overflow: hidden;
        }
        #player { width: 100vw; height: 100vh; }
        #overlay-container {
            position: absolute; top: 20px; left: 0; width: 100%;
            overflow: hidden; pointer-events: none; z-index: 2;
        }
        #viewer-overlay {
            color: #CC0000; font-weight: bold; font-family: sans-serif;
            font-size: 40px; text-shadow: 1px 1px 2px #000;
            display: inline-block; white-space: nowrap;
            will-change: transform; opacity: 0;
        }
        #reward-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.85); color: #FF0000;
            font-weight: bold; font-size: 48px; padding: 30px 60px;
            border-radius: 15px; opacity: 0; transition: opacity 0.5s ease-in-out;
            text-align: center; z-index: 1000;
        }
        #next-song-notification {
            bottom: 80px; left: 0; font-size: 32px; color: #FFFF00;
            display: none;
        }
    </style>

    <script>
    // Marquee động
    (function () {
        let styleEl;
        function injectKeyframes(distance) {
            if (!styleEl) {
                styleEl = document.createElement('style');
                styleEl.id = 'marquee-style';
                document.head.appendChild(styleEl);
            }
            styleEl.textContent = `
                @keyframes marqueeAnim {
                    0% { transform: translateX(0); }
                    100% { transform: translateX(${distance}px); }
                }
            `;
        }
        window.setMarquee = function () {
            const textEl = document.getElementById('viewer-overlay');
            if (!textEl) return;
            const screenWidth = window.innerWidth;
            const textWidth = textEl.scrollWidth;
            const distance = screenWidth - textWidth;
            const duration = Math.max(6000, Math.min(40000, Math.abs(distance) * 12));
            injectKeyframes(distance);
            textEl.style.animation = `marqueeAnim ${duration}ms linear infinite alternate`;
        };
        window.addEventListener('resize', () => {
            clearTimeout(window.__marqueeResizeTimer);
            window.__marqueeResizeTimer = setTimeout(window.setMarquee, 150);
        });
    })();
    </script>
</head>
<body>

<div id="player"></div>
<div id="overlay-container"><div id="viewer-overlay"></div></div>
<div id="next-song-notification"></div>
<div id="reward-overlay"></div>

<script type="text/javascript" src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>
<script>
    const CUSTOM_NAMESPACE = "urn:x-cast:com.tranduyen.chieuyoutube.control";
    const context = cast.framework.CastReceiverContext.getInstance();
    const playerManager = context.getPlayerManager();
    const queueManager = playerManager.getQueueManager();
    const viewerOverlay = document.getElementById('viewer-overlay');
    const rewardOverlay = document.getElementById('reward-overlay');
    let ytPlayer;

    let currentRepeatMode = cast.framework.messages.RepeatMode.OFF;
    let currentMediaItem = null;

    window.onYouTubeIframeAPIReady = function() {
        ytPlayer = new YT.Player('player', {
            height: '100%', width: '100%',
            playerVars: { 'autoplay': 1, 'controls': 0, 'rel': 0 },
            events: { 'onStateChange': onPlayerStateChange }
        });
    };

    function playMediaItem(item) {
        if (!item || !ytPlayer?.loadVideoById) return;
        currentMediaItem = item;
        const videoId = item.media.contentId;
        const customData = item.media.customData;
        ytPlayer.loadVideoById({ videoId: videoId, suggestedQuality: 'hd1080' });
        if (customData?.viewerName) {
            viewerOverlay.innerText = `Ca sỹ trình bày: ${customData.viewerName}`;
            viewerOverlay.style.opacity = 1;
            setTimeout(setMarquee, 0);
        } else {
            viewerOverlay.style.opacity = 0;
            viewerOverlay.style.animation = "none";
        }
        sendCurrentStatus();
    }

    playerManager.setMessageInterceptor(
        cast.framework.messages.MessageType.LOAD,
        loadRequestData => {
            const media = loadRequestData.media;
            const videoId = media.contentId;
            const customData = media.customData || {};
            if (ytPlayer && videoId) {
                ytPlayer.loadVideoById({ videoId, suggestedQuality: 'hd1080' });
            }
            if (customData.viewerName) {
                viewerOverlay.textContent = `Ca sỹ trình bày: ${customData.viewerName}`;
                viewerOverlay.style.opacity = 1;
                setTimeout(setMarquee, 0);
            } else {
                viewerOverlay.textContent = "";
                viewerOverlay.style.opacity = 0;
                viewerOverlay.style.animation = "none";
            }
            sendCurrentStatus();
            return null;
        }
    );

    playerManager.setMessageInterceptor(
        cast.framework.messages.MessageType.PLAY,
        () => { ytPlayer?.playVideo(); return null; }
    );
    playerManager.setMessageInterceptor(
        cast.framework.messages.MessageType.PAUSE,
        () => { ytPlayer?.pauseVideo(); return null; }
    );

    function onPlayerStateChange(event) {
        if (event.data === YT.PlayerState.ENDED) {
            viewerOverlay.style.opacity = 0;
            viewerOverlay.style.animation = "none";
            handleQueueAdvance();
        }
    }

    function handleQueueAdvance() {
        if (currentRepeatMode === cast.framework.messages.RepeatMode.SINGLE) {
            ytPlayer.seekTo(0);
            ytPlayer.playVideo();
        } else {
            const nextItem = queueManager.getNextItem();
            if (nextItem) playMediaItem(nextItem);
        }
    }

    // Nhận custom message từ app
    context.addCustomMessageListener(CUSTOM_NAMESPACE, event => {
        const data = event.data;
        if (data.type === "setRepeatMode") {
            currentRepeatMode = data.mode;
            queueManager.setRepeatMode(currentRepeatMode);
            sendCurrentStatus();
        }
    });

    function sendCurrentStatus() {
        const currentItem = queueManager.getCurrentItem();
        const videoId = currentItem?.media?.contentId || null;
        context.sendCustomMessage(CUSTOM_NAMESPACE, undefined, {
            type: "statusUpdate",
            repeatMode: currentRepeatMode,
            currentlyPlayingVideoId: videoId
        });
    }

    function showRewardMessage(item) {
        if (item?.media?.customData?.viewerName) {
            const viewerName = item.media.customData.viewerName;
            const score = Math.floor(Math.random() * 11) + 90;
            rewardOverlay.innerHTML = `Ca sỹ ${viewerName} đã thể hiện bài hát rất tốt,<br>điểm khen ngợi ${score} điểm.`;
            rewardOverlay.style.opacity = 1;
            setTimeout(() => { rewardOverlay.style.opacity = 0; }, 4000);
        }
    }

    const options = new cast.framework.CastReceiverOptions();
    options.disableIdleTimeout = true;
    context.start(options);

    window.addEventListener('load', () => {
        if (viewerOverlay.textContent.trim() !== "") {
            viewerOverlay.style.opacity = 1;
            setMarquee();
        }
    });
</script>
</body>
</html>
