<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Chiếu YouTube Receiver</title>
    <style>
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: #000; overflow: hidden; color: white;
        }
        cast-media-player {
            width: 100vw; height: 100vh;
        }
        .overlay-base {
            position: absolute; width: 100%; text-align: center;
            font-family: sans-serif; font-weight: bold;
            text-shadow: 2px 2px 4px #000;
            pointer-events: none; z-index: 2;
            box-sizing: border-box; padding: 5px 15px;
        }
        #viewer-overlay-container {
            top: 20px; left: 0; overflow: hidden;
        }
        #viewer-overlay {
            color: #CC0000; font-size: 40px; display: inline-block;
            white-space: nowrap; will-change: transform; opacity: 0;
        }
        #next-song-notification {
            bottom: 80px; left: 0; font-size: 32px; color: #FFFF00;
            display: none;
        }
        #reward-overlay {
            bottom: 20px; left: 0; font-size: 36px; color: #00FF7F; /* Màu xanh lá */
            display: none;
        }
    </style>
    <script>
        // ----- GIỮ LẠI CODE MARQUEE THÔNG MINH CỦA BẠN -----
        (function () {
            let styleEl;
            function injectKeyframes(distance) {
                if (!styleEl) {
                    styleEl = document.createElement('style');
                    styleEl.id = 'marquee-style';
                    document.head.appendChild(styleEl);
                }
                styleEl.textContent = `@keyframes marqueeAnim { 0% { transform: translateX(0); } 100% { transform: translateX(${distance}px); } }`;
            }
            window.setMarquee = function () {
                const textEl = document.getElementById('viewer-overlay');
                if (!textEl || !textEl.textContent.trim()) return;
                const screenWidth = window.innerWidth;
                const textWidth = textEl.scrollWidth;
                const distance = screenWidth - textWidth;
                const duration = Math.max(8000, Math.min(40000, Math.abs(distance) * 20));
                injectKeyframes(distance);
                textEl.style.animation = `marqueeAnim ${duration}ms linear infinite alternate`;
                textEl.style.opacity = 1;
            };
            window.addEventListener('resize', () => {
                clearTimeout(window.__marqueeResizeTimer);
                window.__marqueeResizeTimer = setTimeout(window.setMarquee, 150);
            });
        })();
    </script>
</head>
<body>
    <cast-media-player></cast-media-player>

    <div id="viewer-overlay-container" class="overlay-base">
        <div id="viewer-overlay"></div>
    </div>
    <div id="next-song-notification" class="overlay-base"></div>
    <div id="reward-overlay" class="overlay-base"></div>

    <script type="text/javascript" src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <script>
        const context = cast.framework.CastReceiverContext.getInstance();
        const playerManager = context.getPlayerManager();

        // Lấy các phần tử DOM
        const viewerOverlay = document.getElementById('viewer-overlay');
        const nextSongNotification = document.getElementById('next-song-notification');
        const rewardOverlay = document.getElementById('reward-overlay');

        // Biến toàn cục để quản lý
        let timeCheckInterval = null;
        let notificationShown = false;
        let currentMediaItem = null; // Lưu thông tin bài hát đang phát

        // Lắng nghe sự kiện thay đổi trạng thái của trình phát
        playerManager.addEventListener(
            cast.framework.events.EventType.PLAYER_STATE_CHANGED,
            (event) => {
                // Ẩn các thông báo khi có thay đổi trạng thái
                rewardOverlay.style.display = 'none';
                nextSongNotification.style.display = 'none';

                if (event.playerState === cast.framework.messages.PlayerState.PLAYING) {
                    startCheckingTime();
                } else {
                    stopCheckingTime();
                    // KIỂM TRA NẾU VIDEO VỪA KẾT THÚC
                    if (event.playerState === cast.framework.messages.PlayerState.IDLE &&
                        event.idleReason === cast.framework.messages.IdleReason.ENDED) {
                        // Gọi hàm hiển thị khen thưởng
                        showRewardMessage(currentMediaItem);
                    }
                }
            }
        );

        // Lắng nghe sự kiện thay đổi thông tin media (khi chuyển bài)
        playerManager.addEventListener(cast.framework.events.EventType.MEDIA_STATUS, (event) => {
            if (event.mediaStatus.media) {
                currentMediaItem = event.mediaStatus.media; // Lưu lại media hiện tại
                const customData = currentMediaItem.customData || {};
                
                if (customData.viewerName) {
                    viewerOverlay.textContent = `Ca sỹ: ${customData.viewerName}`;
                    setTimeout(window.setMarquee, 0); // Kích hoạt marquee thông minh của bạn
                } else {
                    viewerOverlay.textContent = "";
                    viewerOverlay.style.opacity = 0;
                    viewerOverlay.style.animation = "none";
                }
            }
        });

        // Hàm hiển thị thông báo khen thưởng
        function showRewardMessage(item) {
            if (item && item.customData && item.customData.viewerName) {
                const viewerName = item.customData.viewerName;
                const score = Math.floor(Math.random() * 11) + 90; // Điểm từ 90-100
                
                rewardOverlay.innerHTML = `Ca sỹ ${viewerName} đã thể hiện rất tốt!<br>${score} điểm khen ngợi.`;
                rewardOverlay.style.display = 'block';
                
                // Tự động ẩn sau 4 giây
                setTimeout(() => { rewardOverlay.style.display = 'none'; }, 4000);
            }
        }

        // Hàm kiểm tra thời gian để báo bài tiếp theo
        function startCheckingTime() {
            stopCheckingTime();
            notificationShown = false;
            
            timeCheckInterval = setInterval(() => {
                const currentTime = playerManager.getCurrentTimeSec();
                const duration = playerManager.getDurationSec();

                if (duration > 0 && (duration - currentTime <= 5) && !notificationShown) {
                    notificationShown = true;
                    const nextItem = playerManager.getQueueManager().getNextItem();
                    if (nextItem) {
                        const nextTitle = nextItem.media.metadata.title;
                        const nextViewer = nextItem.media.customData.viewerName;
                        nextSongNotification.innerText = `Tiếp theo: ${nextTitle} (Ca sỹ: ${nextViewer})`;
                        nextSongNotification.style.display = 'block';
                    }
                    stopCheckingTime();
                }
            }, 1000);
        }

        function stopCheckingTime() {
            if (timeCheckInterval) clearInterval(timeCheckInterval);
            timeCheckInterval = null;
        }

        const options = new cast.framework.CastReceiverOptions();
        options.disableIdleTimeout = true;
        context.start(options);
    </script>
</body>
</html>
